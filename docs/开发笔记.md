# 开发笔记

## 1.1 论证阶段

## 1.2 设计阶段

### 架构设计

> config 定义“系统怎么被配置”
> database 定义“如何连接基础设施”
> repository 定义“业务如何访问数据”

三者**绝不互相越权**。

#### 三层的“职责边界”——正反例

##### 1️⃣ config ——“事实来源（Source of Truth）”

> config 应该做什么

* 定义 **配置结构体**
* 负责 **加载 / 解析 / 校验配置**
* 不关心数据库、Redis、业务

> config 不应该做什么

* ❌ 不创建数据库连接
* ❌ 不 import database / redis / sql
* ❌ 不包含任何业务语义

> 正确内容示例

```go
//internal/config/config.go
type MySQLConfig struct {
	DSN string `yaml:"dsn"`
}
```

##### 2️⃣ database ——“基础设施初始化器”

> database 应该做什么

* 根据 **config 提供的参数**
* 初始化 **连接池 / 客户端**
* 提供 **全局可复用实例**

> database 不应该做什么

* ❌ 不定义配置结构
* ❌ 不写 SQL
* ❌ 不知道“用户 / 订单”是什么

> 正确内容示例

```go
//internal/pkg/database/mysql.go
func InitMySQL(cfg config.MySQLConfig) error {
	//只关心如何连，不关心数据
}
```

##### 3️⃣ repository ——“数据访问的业务视角”

> repository 应该做什么

* 定义 **面向业务的接口**
* 实现 CRUD / 查询
* 封装 SQL / Redis 操作细节

> repository 不应该做什么

* ❌ 不加载配置
* ❌ 不初始化连接池
* ❌ 不返回 sql.Rows / redis.Cmd


#### 依赖方向

```
config
   ↓
database
   ↓
repository
   ↓
service
   ↓
api(handler)
```

**任何反向依赖，都是设计错误。**

这一点是后面 **撮合引擎能否独立演进的关键**。

#### 几个设计雷区

- ❌ database 里出现 SQL

- ❌ repository 里读取 config

- ❌ service import database

- ❌ handler 直接操作 sql.DB

- ❌ config import gin / mysql / redis

只要出现一个，后期必重构。

#### 单请求调用链图

![单请求调用链图](https://www.plantuml.com/plantuml/png/RP3FRi8m3CRlVWgB4nnuWHqcnD20QNz6ORTTijOJaKAQ9SwcllrSDuXLu-RwztFrVLaaDf7poG5RTeGLVMLAZFUk_S4vhednBL74POVR5O2fkOruvonvXY2NjhR1UCR9sdgisimK9sXI6STA_wEDyOqhZixNf3t5RrkJIcN-BrKKscGbJlVkfzOpnKzJqqoFUdRzOlhKxNUF5sjx2WuQm-R39CA9KeMh9S3G4-UtfGxUuEPmU3q_4fIjSAsYGcsSmsDffcirpZt4M1FtQQQscK7PYg1f1hhijYkbkXgG1XNSs1GCrqSuxuHBLY4I77UPOWVoEHzVHKhPyP-RKQ0-pIN9g8sYygbeU18X3_kNPwmeXTOdWWNv9f_SBm00)

## 1.3 搭建阶段

### 建立一条最小可运行链路（Minimum Runnable Skeleton, MRS），确保：

配置能加载 → 基础依赖能初始化（MySQL / Redis）→ Gin 能启动 → 有一个健康接口可访问

#### 1

现在应该做的不是“业务”，而是 4 件事——按优先级排序：

1. 确定程序入口（cmd/server/main.go）
2. 实现配置加载（internal/config）
3. 初始化基础资源（MySQL / Redis）
4. 启动 Gin + 一个 health 接口

撮合引擎、RBAC、订单 CRUD 都暂时不要碰。

#### 2

```go
package main

import (
	"log"

	"ebidsystem_csm/internal/config"
	"ebidsystem_csm/internal/pkg/database"
	"ebidsystem_csm/internal/api/route"
)

func main() {
	//1.加载配置
	cfg, err := config.Load()
	if err != nil {
		log.Fatalf("load config failed: %v", err)
	}

	//2.初始化数据库
	if err := database.InitMySQL(cfg.MySQL); err != nil {
		log.Fatalf("init mysql failed: %v", err)
	}

	if err := database.InitRedis(cfg.Redis); err != nil {
		log.Fatalf("init redis failed: %v", err)
	}

	//3.启动 HTTP 服务
	r := route.SetupRouter()
	if err := r.Run(cfg.Server.Addr); err != nil {
		log.Fatalf("server start failed: %v", err)
	}
}

```

###

## 2. 编写阶段