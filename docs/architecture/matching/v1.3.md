# 撮合引擎-1.3

## 部分成交支持

### 1. 引入 Remaining 概念（撮合引擎内部）

**改动前**
- 使用 order.Quantity 表示“还可成交的数量”

**改动后**
- 初始：
  Remaining = Quantity
- 每次撮合：
  Remaining -= matchedQty

Remaining 是**撮合引擎内部状态**，不直接依赖数据库字段。


### 2. 撮合算法改为“最小剩余量成交”

```go
matchedQty = min(buy.Remaining, sell.Remaining)
```

确保不会出现“超卖 / 超买”，为多次撮合奠定基础

### 3. 订单簿移除逻辑调整
```go
if buy.Remaining == 0 {
    remove buy order
}
if sell.Remaining == 0 {
    remove sell order
}
```
关键点：

同一订单可能在多轮 Match 中存在

只有 Remaining 为 0 才真正“出簿”

### 4. 撮合事件（MatchEvent）改为“增量事件”
每个事件只代表本次成交量：

```go
type MatchEvent struct {
    BuyOrderID
    SellOrderID
    Price
    Quantity   // 本次成交量
}
而不是“订单最终状态”。

### 5. 数据库侧引入 filled_quantity
```sql
filled_quantity BIGINT NOT NULL DEFAULT 0
```
并通过 累加更新：

```sql
filled_quantity = filled_quantity + ?
```
避免：

覆盖式更新

并发下的成交丢失

### 6. 状态推进规则收敛到数据库层
```sql
CASE
  WHEN filled_quantity + ? >= quantity THEN 'filled'
  ELSE 'partial'
END
```
状态语义明确：

pending：未成交

partial：已部分成交，仍可成交

filled：已完全成交，不可再动