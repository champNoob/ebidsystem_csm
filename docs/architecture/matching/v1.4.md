# 撮合引擎-1.4

## 多协程撮合引擎

### 当前版本的订单提交流程

```txt
CreateOrder
  → matcher.Submit(order)
      → engine.orderCh (单一 channel)
          → Start() goroutine
              → 按 symbol 找 OrderBook
              → ob.AddOrder
              → ob.Match
```

#### ✅ 优点

- 全局只有一个 goroutine 在撮合
- 所有 symbol 共用一个 orderCh
- 当前阶段不会出现数据竞争

#### ❌ 致命问题

- 所有 symbol 共用一个撮合循环
- AAPL 的高频撮合会阻塞 BTC、ETH
- 无法并行扩展
- 多核 CPU 完全浪费
- 未来一旦加事件回写 DB（Fill / Trade）
- 会被一个慢 SQL 拖死所有 symbol
- 逻辑上不符合真实交易所模型

> 真实世界的 symbol 是**天然隔离**的撮合单元

所以必须做 **symbol 级串行**，而不是全局串行

### 目标架构

在引擎（Engine）和订单簿（OrderBook）之间，引入股票代码级（symbol 级）的撮合器 **symbol_matcher**，
使得 OrderBook 不再被 Engine 直接操作，而是由 symbol_matcher 统一管理。

```txt
CreateOrder
   |
   v
Engine.Submit(order)
   |
   v
dispatcher goroutine
   |
   +── AAPL matcher goroutine (串行)
   |
   +── BTC matcher goroutine (串行)
   |
   +── ETH matcher goroutine (串行)
```

```txt
                ┌──────────────┐
Submit ───────▶│   Engine     │
                │              │
                │ map[symbol]  │
                │   ↓          │
                │ SymbolMatcher│
                │   ↓          │
                │ OrderBook    │
                │              │
                │ eventCh ◀───┴── MatchEvent
                └──────┬───────┘
                       │
                       ▼
             OrderService.StartMatchEventListener
```

### 最终职责划分

#### Engine

> 全局调度器

- 只负责：

    - 接收订单（Submit）
    - 按 symbol 路由订单
    - 汇总撮合事件（event fan-in）

- 不应该：

    - 直接调用 OrderBook.AddOrder / Match
    - 理解撮合细节
    - 处理并发细节

#### `SymbolMatcher`（核心）

> `symbol` 级串行执行单元，撮合串行化模型的**实体承载者**

- 职责：

    - 一个 `symbol` = 一个 `goroutine`
    - 串行处理该 `symbol` 下的：新订单、撤单等功能
    - 内部持有：一个 `OrderBook`、一个私有的 `orderCh` / `cancelCh`
    - 将撮合结果推送到 Engine 提供的 `eventCh`

#### OrderBook

> 纯内存数据结构，应该是完全“傻”的对象

- 职责：

    - 维护买卖盘
    - 执行撮合算法（Match()）

- 不关心：

    - 并发
    - goroutine
    - channel
    - 数据库
    - Engine

### 主要更改

#### 1. 添加 `internal\matching\symbol_matcher.go`

- OrderBook 不加锁
- Match() 不加锁

安全性来自**单 goroutine**

#### 2. 重构 Engine：从“全局撮合”变成“symbol 路由器”

- 修改 `internal/matching/engine.go`
- 修改 `NewEngine`
- 修改 `Start()`（核心修改）

#### 3. `symbol_matcher.go` 的撤单功能

- 添加 `removeCh` 用于接收撤单请求
- 在 `Start()` 中的 `goroutine` 中添加 `select` 语句，处理 `removeCh`

### 测试

## 订单状态机

## 撮合事件 DB 事务化

## 引擎重启恢复机制
